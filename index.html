<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محاسبه جدول رنگی مواد غذایی</title>

  <!-- خوش‌آمدگویی -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: Tahoma, sans-serif;
      background-color: #f9f9f9;
      direction: rtl;
      padding: 20px;
      position: relative;
    }

    table {
      border-collapse: collapse;
      width: 160%;
      max-width: 500px;
      margin: 0 auto 30px;
      background-color: #fff;
    }

    th, td {
      border: 2px solid #5300AD;
      padding: 2px;
      text-align: center;
      font-size: 17px;
    }

    th {
      background-color: #BEB567;
    }

    input, select {
      width: 90%;
      padding: 6px;
      font-size: 17px;
      margin: 4px 0;
    }

    .green { background-color: #00FF00; color: #256029; }
    .orange { background-color: #FFAF1C; color: #000; }
    .red { background-color: #FF0000; color: #FFF; }

    .float-container {
      position: fixed;
      bottom: 30px;
      right: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 8px;
      z-index: 100;
    }
    .float-btn {
      background-color: #2563EB;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .float-btn:hover {
      background-color: #1E40AF;
    }

    @media print {
      body * { visibility: hidden; }
      #exportArea, #exportArea * { visibility: visible; }
      #exportArea {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
      }
      table, th, td {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* خوش‌آمدگویی */
    #welcomeOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(115deg, #2163EB, #2CA7EC);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    #welcomeOverlay .box {
      background: #ffff;
      padding: 50px 50px;
      border-radius: 10px;
      text-align: center;
      max-width: 600px;
      animation: fadeInOut 5s forwards;
    }
    #welcomeOverlay .box h1 {
      margin: 0 0 10px;
      font-family: 'Dancing Script', cursive;
      font-size: 22px;
      color: #000000;
      line-height: 1.3;
    }
    #welcomeOverlay .box .author {
      font-size: 18px;
      margin-bottom: 15px;
    }
    #welcomeOverlay .box .spinner {
      margin: 0 auto 15px;
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563EB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    #welcomeOverlay .box .copyright {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes fadeInOut {
      0%   { opacity: 0; }
      10%  { opacity: 1; }
      90%  { opacity: 1; }
      100% { opacity: 0; display: none; }
    }

    /* راهنما */
    #helpOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    #helpOverlay .box {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      max-width: 500px;
      text-align: right;
      line-height: 1.6;
      position: relative;
    }
    #helpOverlay .close-btn {
      position: absolute;
      top: 8px; left: 8px;
      background: #e53e3e;
      border: none;
      color: #fff;
      border-radius: 50%;
      width: 28px; height: 28px;
      font-size: 18px;
      cursor: pointer;
    }
    #helpOverlay h2 {
      margin-top: 0;
      font-size: 20px;
      text-align: center;
    }
    #helpOverlay ol {
      padding-right: 16px;
    }
    #helpOverlay ol li {
      margin-bottom: 8px;
    }
    #helpOverlay .contact, 
    #helpOverlay .feedback {
      margin-top: 12px;
      font-size: 14px;
    }
    #helpOverlay .contact strong {
      display: block;
      margin-bottom: 4px;
    }
    #helpOverlay .feedback ul {
      padding-right: 16px;
    }
    #helpOverlay .feedback ul li {
      margin-bottom: 4px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

  <!-- خوش‌آمدگویی -->
  <div id="welcomeOverlay">
    <div class="box">
      <h1>نرم‌افزار محاسبه جدول رنگی مواد غذایی<br>
        بر اساس آخرین ویرایش ضوابط برچسب‌گذاری<br>
        اداره نظارت بر مواد غذایی
      </h1>
      <div class="author">نویسنده: مصیب خانی – کارشناس کنترل کیفیت</div>
      <div class="spinner"></div>
      <div class="copyright">
        © 2025 آزمایشگاه و کنترل کیفیت کارخانه یک و یک دشت مرغاب. All rights reserved.
      </div>
    </div>
  </div>

  <!-- فرم ورودی -->
  <table>
    <tr><th>نام ماده غذایی</th>
      <td><input type="text" id="foodName" oninput="render()"></td>
    </tr>
    <tr><th>نوع ماده غذایی</th>
      <td>
        <select id="foodType" onchange="updateServingUnits(); render()">
          <option value="جامد">جامد</option>
          <option value="مایع">مایع</option>
        </select>
      </td>
    </tr>
    <tr><th>اندازه سهم</th>
      <td><input type="number" id="servingSize" oninput="render()"></td>
    </tr>
    <tr><th>واحد سهم</th>
      <td><select id="servingUnit" onchange="render()"></select></td>
    </tr>
    <tr><th>معیار سهم</th>
      <td>
        <input list="servingCriteria" id="servingCriterion" oninput="render()">
        <datalist id="servingCriteria">
          <option value="1 قاشق چایخوری"><option value="1 قاشق غذاخوری"><option value="2 قاشق غذاخوری">
          <option value="1 قاشق مرباخوری"><option value="2 قاشق مرباخوری">
          <option value="1 قاشق چایخوری"><option value="1 فنجان"><option value="1/2 فنجان">
          <option value="1 عدد"><option value="2 عدد">
          <option value="3 عدد"><option value="5 عدد"><option value="7 عدد"><option value="5 تکه">
          <option value="10 اسلایس"><option value="11 اسلایس"><option value="12 اسلایس"><option value="13 اسلایس">
        </datalist>
      </td>
    </tr>
    <tr><th>انرژی در 100 گرم</th>
      <td><input type="number" id="energy100" oninput="render()"></td>
    </tr>
    <tr><th>قند در 100 گرم</th>
      <td><input type="number" id="sugar100" oninput="render()"></td>
    </tr>
    <tr><th>چربی در 100 گرم</th>
      <td><input type="number" id="fat100" oninput="render()"></td>
    </tr>
    <tr><th>نمک در 100 گرم</th>
      <td><input type="number" id="salt100" oninput="render()"></td>
    </tr>
    <tr><th>اسیدچرب ترانس در 100 گرم</th>
      <td><input type="number" id="trans100" oninput="render()"></td>
    </tr>
  </table>

  <!-- ناحیه خروجی -->
  <div id="exportArea">
    <div id="resultContainer"></div>
  </div>

  <!-- دکمه‌های شناور -->
  <div class="float-container">
    <button class="float-btn" title="راهنمای برنامه" onclick="toggleHelp()">❔</button>
    <button class="float-btn" title="ریست داده ها" onclick="clearInputs()">🔄</button>
    <button class="float-btn" title="ذخیره Excel" onclick="exportExcel()">📊</button>
    <button class="float-btn" title="پرینت جدول" onclick="printTable()">🖨️</button>
    <button class="float-btn" title="ذخیره تصویر" onclick="saveAsJPG()">💾</button>
  </div>

  <!-- پنجره راهنما -->
  <div id="helpOverlay">
    <div class="box">
      <button class="close-btn" onclick="toggleHelp()">×</button>
      <h2>راهنمای کار با نرم‌افزار</h2>
      <ol>
        <li>نام ماده غذایی را وارد کنید.</li>
        <li>نوع (جامد/مایع) را انتخاب کنید تا واحدهای سهم به‌روز شوند.</li>
        <li>اندازه و معیار سهم را وارد کنید.</li>
        <li>مقادیر انرژی، قند، چربی، نمک و TFA را بر حسب 100 گرم وارد کنید.</li>
        <li>با فشردن Enter به فیلد بعدی منتقل شوید.</li>
        <li>برای پاک‌سازی فیلدها دکمه «🔄» را بزنید.</li>
        <li>برای خروجی Excel با ساختار ورودی و پارامترها دکمه «📊» را انتخاب کنید.</li>
        <li>برای پرینت رنگی جدول «🖨️» و برای ذخیره JPG «💾» را بزنید.</li>
      </ol>
      <div class="contact">
        <strong>نویسنده:</strong> مصیب خانی<br>
        <strong>ایمیل:</strong> mosayeb872@gmail.com<br>
        <strong>تلفن:</strong> 0917-320-6052
      </div>
      <div class="feedback">
        <strong>پیشنهادات و انتقادات:</strong>
        <ul>
          <li>لطفاً نظرات و مشکلات را از طریق ایمیل بالا ارسال کنید.</li>
          <li>برای گزارش باگ‌ها و درخواست ویژگی‌های جدید خوشحال می‌شویم همکاری کنید.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const rules = {
      جامد: { fat:[3,17.5], sugar:[5,22.5], salt:[0.3,1.5], trans:[0.5,2] },
      مایع:{ fat:[1.5,8.75], sugar:[2.5,11.25], salt:[0.3,0.75], trans:[0.5,2] }
    };
    const translations = {
      'انرژی':'Energy','قند':'Sugar','چربی':'Fat',
      'نمک':'Salt','اسیدچرب ترانس':'TFA'
    };

    function updateServingUnits() {
      const type = document.getElementById("foodType").value;
      const sel  = document.getElementById("servingUnit");
      sel.innerHTML = "";
      const units = type==="جامد"
        ? ["گرم","عدد","تکه","اسلایس"]
        : ["میلی‌لیتر","قاشق غذاخوری","فنجان"];
      units.forEach(u=>{
        const o=document.createElement("option");
        o.value=u; o.textContent=u;
        sel.appendChild(o);
      });
    }

    function getColor(val, size, [g100,o100]) {
      if(size===0) return "";
      if(val===0) return "green";
      const gMax=g100*size/100, oMax=o100*size/100;
      if(val<=gMax) return "green";
      if(val<=oMax) return "orange";
      return "red";
    }

    function render() {
      const name=document.getElementById("foodName").value.trim();
      const size=+document.getElementById("servingSize").value||0;
      if(!name||size<=0){
        document.getElementById("resultContainer").innerHTML="";
        return;
      }
      const type=document.getElementById("foodType").value;
      const unit=document.getElementById("servingUnit").value;
      const crit=document.getElementById("servingCriterion").value;
      const e100=+document.getElementById("energy100").value||0;
      const s100=+document.getElementById("sugar100").value||0;
      const f100=+document.getElementById("fat100").value||0;
      const sa100=+document.getElementById("salt100").value||0;
      const t100=+document.getElementById("trans100").value||0;

      const vals=[
        (e100*size/100).toFixed(2),
        +(s100*size/100).toFixed(2),
        +(f100*size/100).toFixed(2),
        +(sa100*size/100).toFixed(2),
        +(t100*size/100).toFixed(2)
      ];
      const keysFa=['انرژی','قند','چربی','نمک','اسیدچرب ترانس'];
      const classes=[
        "", getColor(vals[1],size,rules[type].sugar),
           getColor(vals[2],size,rules[type].fat),
           getColor(vals[3],size,rules[type].salt),
           getColor(vals[4],size,rules[type].trans)
      ];
      const shareLabel=crit
        ? `${crit} ${name} – ${size} ${unit}`
        : `${name} – ${size} ${unit}`;

      let html=`<table>
        <tr><th>ماده مغذی / Nutrient</th><th>اندازه سهم (${shareLabel})</th></tr>`;
      keysFa.forEach((fa,i)=>{
        const en=translations[fa];
        const unitLbl=i===0?'کیلوکالری':'گرم';
        html+=`<tr class="${classes[i]}"><td>${fa}/${en}</td>
               <td>${vals[i]} ${unitLbl}</td></tr>`;
      });
      html+="</table>";
      document.getElementById("resultContainer").innerHTML=html;
    }

    function saveAsJPG() {
      const name=document.getElementById("foodName").value.trim()||'table';
      html2canvas(document.getElementById("exportArea"),{backgroundColor:'#fff',scale:2})
        .then(canvas=>{
          const link=document.createElement("a");
          link.href=canvas.toDataURL("image/jpeg",0.9);
          link.download=`${name.replace(/\s+/g,'_')}.jpg`;
          link.click();
        });
    }

    function printTable(){ window.print(); }

    function clearInputs(){
      document.querySelectorAll("input").forEach(i=>i.value="");
      document.getElementById("foodType").value="جامد";
      updateServingUnits(); render();
    }

    function exportExcel(){
      const name=document.getElementById("foodName").value.trim()||'table';
      const type=document.getElementById("foodType").value;
      const size=document.getElementById("servingSize").value;
      const unit=document.getElementById("servingUnit").value;
      const crit=document.getElementById("servingCriterion").value;
      const e100=document.getElementById("energy100").value;
      const s100=document.getElementById("sugar100").value;
      const f100=document.getElementById("fat100").value;
      const sa100=document.getElementById("salt100").value;
      const t100=document.getElementById("trans100").value;

      let excel=`<html xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:x="urn:schemas-microsoft-com:office:excel"><head><meta charset="utf-8"></head><body>`;
      excel+=`<table><tr><th colspan="2">اطلاعات ورودی</th></tr>`;
      excel+=`<tr><td>نام ماده غذایی</td><td>${name}</td></tr>`;
      excel+=`<tr><td>نوع</td><td>${type}</td></tr>`;
      excel+=`<tr><td>اندازه سهم</td><td>${size} ${unit}</td></tr>`;
      excel+=`<tr><td>معیار سهم</td><td>${crit}</td></tr>`;
      excel+=`<tr><td>انرژی</td><td>${e100} (100g)</td></tr>`;
      excel+=`<tr><td>قند</td><td>${s100} (100g)</td></tr>`;
      excel+=`<tr><td>چربی</td><td>${f100} (100g)</td></tr>`;
      excel+=`<tr><td>نمک</td><td>${sa100} (100g)</td></tr>`;
      excel+=`<tr><td>TFA</td><td>${t100} (100g)</td></tr>`;
      excel+=`<tr><th colspan="2">پارامترهای آستانه (100g)</th></tr>`;
      ['جامد','مایع'].forEach(key=>{
        excel+=`<tr><th colspan="2">${key}</th></tr>`;
        ['sugar','fat','salt','trans'].forEach(n=>{
          const [g,o]=rules[key][n];
          const label={'sugar':'قند','fat':'چربی','salt':'نمک','trans':'TFA'}[n];
          excel+=`<tr><td>${label}</td><td>سالم ≤${g}, متوسط ≤${o}</td></tr>`;
        });
      });
      excel+=`</table></body></html>`;

      const blob=new Blob([excel],{type:'application/vnd.ms-excel'});
      const link=document.createElement('a');
      link.href=URL.createObjectURL(blob);
      link.download=`${name.replace(/\s+/g,'_')}.xls`;
      link.click();
    }

    function toggleHelp(){
      const h=document.getElementById("helpOverlay");
      h.style.display = h.style.display==='flex'?'none':'flex';
    }

    window.onload = ()=>{
      updateServingUnits(); render();
      setTimeout(()=> {
        document.getElementById("welcomeOverlay").style.display='none';
      }, 5000);
      const fields=Array.from(document.querySelectorAll("input, select"));
      fields.forEach((f,i)=> {
        f.addEventListener("keydown", e=>{
          if(e.key==='Enter'){
            e.preventDefault();
            fields[i+1]?.focus();
          }
        });
      });
    };
  </script>
</body>
</html>
